<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>i-One Car | ìƒì„¸ ê²¬ì </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
    <link rel="stylesheet" th:href="@{/css/compare.css}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />
</head>
<body>
<div class="container">
    <div class="main-header">
        <span class="header-title">i-One Car ã…£ ê²¬ì  ìƒì„¸</span>
        <button class="close-btn">
            <img th:src="@{/css/images/X.png}" alt="ë‹«ê¸°" class="close-icon" />
        </button>
    </div>
    <div class="detail-card">
        <!-- ì°¨ëŸ‰ì •ë³´/ì´ë¯¸ì§€ -->
        <div class="car-info-row">
            <div class="car-info-text">
                <div class="car-name" th:text="${carClass}"></div>
                <div class="car-desc">
                    <span th:text="${carSubClass}"></span><br/>
                    <span th:if="${purchase != null and purchase.purchaseMethod == 'C'}">ì¼ì‹œë¶ˆ</span>
                    <span th:if="${purchase == null or purchase.purchaseMethod != 'C'}">
                        <span th:text="${purchaseMethod}"></span>
                        <span th:text="${purchasePeriod} + 'ê°œì›”'"></span>
                    </span>
                </div>
            </div>
            <div class="car-img-block">
                <img th:src="@{${carClass == 'A-Class' ? '/css/images/a-class.png' : '/css/images/bmwx1.png'}}" alt="ì°¨ ì´ë¯¸ì§€" class="car-img" />
            </div>
        </div>

        <!-- ê°€ê²©ì •ë³´: í•˜ë‚˜ì˜ íšŒìƒ‰ ë°•ìŠ¤ -->
        <div class="price-area-box">
            <!-- ì°¨ëŸ‰ ê¸°ë³¸ê°€ -->
            <div class="price-detail">
                <span class="label">ì°¨ëŸ‰ ê¸°ë³¸ê°€</span>
                <span class="price-value" th:text="${#numbers.formatInteger(carPrice, 0, 'COMMA')} + 'ì›'"></span>
            </div>
            <!-- ì¶”ê°€ ì˜µì…˜ê°€ -->
            <div class="price-detail">
                <span class="label">ì¶”ê°€ ì˜µì…˜ê°€</span>
                <span class="price-value" th:text="${#numbers.formatInteger(optPrice, 0, 'COMMA')} + 'ì›'"></span>
            </div>
            <!-- ì´ ì˜ˆìƒê¸ˆì•¡ -->
            <div class="price-detail total">
                <span class="label">ì´ ì˜ˆìƒê¸ˆì•¡</span>
                <span class="price-value" th:text="${#numbers.formatInteger(carPrice + optPrice, 0, 'COMMA')} + 'ì›'"></span>
            </div>
        </div>

        <!-- ë”œëŸ¬ ì •ë³´ë¥¼ ë™ì ìœ¼ë¡œ í‘œì‹œ -->
        <div th:each="compare : ${compares}" class="dealer-label-with-card">
            <div class="dealer-label" 
                 th:text="${compare.progress == '1' ? 'ë”œëŸ¬ì™€ ìƒë‹´ìš”ì²­ ì „ì…ë‹ˆë‹¤.' : (compare.progress == '2' ? 'ë”œëŸ¬ì™€ ìƒë‹´ì´ ì§„í–‰ì¤‘ì…ë‹ˆë‹¤.' : (compare.progress == '3' ? 'ë”œëŸ¬ì™€ ìƒë‹´ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë”œëŸ¬ì™€ ìƒë‹´ìš”ì²­ ì „ì…ë‹ˆë‹¤.'))}"
                 th:style="${compare.progress == '2' ? 'color: red;' : (compare.progress == '3' ? 'color: green; font-weight: bold;' : '')}"></div>
            <div class="dealer-card">
                <img th:src="@{${compare.dealerName == 'ë²¤ì¸ ë°•ì‚¬' ? '/css/images/dealer1.png' : '/css/images/dealer2.png'}}" alt="ë”œëŸ¬ í”„ë¡œí•„" class="dealer-photo" />
                <div class="dealer-profile-info">
                    <span class="dealer-name" th:onclick="'goToProfile(\'' + ${compare.dealerNo} + '\')'" style="cursor: pointer;" th:text="${compare.dealerName}">ë”œëŸ¬ëª…</span>
                    <span class="dealer-rating">
                        <img th:src="@{/css/images/star.png}" alt="ë³„" class="star-icon" />
                        <span th:text="${compare.rating}">5.0</span>
                        <span class="review-count" th:text="'(' + ${compare.reviewCnt} + ')'"></span>
                    </span>
                    <span class="quotation-count" th:text="${compare.quotationCnt} + 'ê±´'"></span>
                </div>
                <div class="dealer-body">
                    <div class="info-col">
                        <span class="label">í• ì¸ê¸ˆì•¡</span>
                        <span class="value" th:text="${#numbers.formatInteger(compare.discount, 0, 'COMMA')} + 'ì›'"></span>
                    </div>
                    <!-- êµ¬ë§¤ë°©ë²•ì— ë”°ë¥¸ ì¡°ê±´ë¶€ í‘œì‹œ -->
                    <div th:if="${purchase != null and purchase.purchaseMethod == 'C'}" class="info-col">
                        <span class="label">ì¼ì‹œë‚©</span>
                        <span class="value" th:text="${#numbers.formatInteger((carPrice + optPrice - compare.discount) + ((carPrice * 0.07) + (carPrice * 0.12 * 0.05)), 0, 'COMMA')} + 'ì›'"></span>
                    </div>
                    <div th:if="${purchase == null or purchase.purchaseMethod != 'C'}" class="info-col">
                        <span class="label">ì›”ë‚©ì…ë£Œ</span>
                        <span class="value" 
                              th:if="${purchase != null and compare.rate != null and purchase.purchaseAdvance != null and purchase.purchasePeriod != null}" 
                              th:text="${#numbers.formatInteger(T(java.lang.Math).round((carPrice + optPrice - compare.discount - purchase.purchaseAdvance ) * (1 + compare.rate/100) / purchase.purchasePeriod), 0, 'COMMA')} + 'ì›'"></span>
                        <span class="value" 
                              th:unless="${purchase != null and compare.rate != null and purchase.purchaseAdvance != null and purchase.purchasePeriod != null}" 
                              th:text="${#numbers.formatInteger(compare.monthlyPayment != null ? compare.monthlyPayment : 0, 0, 'COMMA')} + 'ì›'"></span>
                    </div>
                    <!-- ì´ìš©ê¸ˆë¦¬ëŠ” ì¼ì‹œë¶ˆ('C')ì´ ì•„ë‹ ë•Œë§Œ í‘œì‹œ -->
                    <div th:if="${purchase == null or purchase.purchaseMethod != 'C'}" class="info-col">
                        <span class="label">ì´ìš©ê¸ˆë¦¬</span>
                        <span class="value" th:text="${compare.rate} + '%'"></span>
                    </div>
                </div>
                <!-- ê¸°ì¡´ ë‹¨ì¼ ë²„íŠ¼ (progressê°€ 2ê°€ ì•„ë‹Œ ê²½ìš°) -->
                <a th:if="${compare.progress != '2'}" th:href="@{/myquote/detail(carSrn=${carSrn}, dealerNo=${compare.dealerNo})}" class="dealer-detail-btn">ìƒì„¸ê²¬ì </a>

                <!-- progressê°€ 2ì¸ ê²½ìš° 3ê°œ ë²„íŠ¼ -->
                <div th:if="${compare.progress == '2'}" class="triple-button-container">
                    <a th:href="@{/myquote/detail(carSrn=${carSrn}, dealerNo=${compare.dealerNo})}" class="triple-btn detail-btn">ìƒì„¸ê²¬ì </a>
                    <button class="triple-btn chat-btn" th:data-dealer-no="${compare.dealerNo}" onclick="startChat(this.getAttribute('data-dealer-no'))">ì±„íŒ…í•˜ê¸°</button>
                    <button class="triple-btn phone-btn" th:data-dealer-no="${compare.dealerNo}" onclick="makeCall(this.getAttribute('data-dealer-no'))">
                        <img th:src="@{/css/images/phone-icon.png}" alt="ì „í™”" class="phone-icon" />
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì „í™” ëª¨ë‹¬ -->
<div id="phoneModal" class="phone-modal-overlay" style="display: none;">
    <div class="phone-modal">
        <div class="phone-modal-content">
            <div class="phone-icon-large">ğŸ“</div>
            <div class="phone-number" id="phoneNumber">í†µí™” 070-5854-8997</div>
            <div class="phone-buttons">
                <button class="phone-call-btn" onclick="actualCall()">
                    <span class="phone-btn-icon">ğŸ“</span>
                    í†µí™”
                </button>
                <button class="phone-cancel-btn" onclick="closePhoneModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ë”œëŸ¬ í”„ë¡œí•„ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
    function goToProfile(dealerNo) {
        window.location.href = '/profile?dealerNo=' + dealerNo;
    }

    // ì±„íŒ… ì‹œì‘ í•¨ìˆ˜
    function startChat(dealerNo) {
        console.log('startChat í•¨ìˆ˜ í˜¸ì¶œë¨, dealerNo:', dealerNo);
        // ì±„íŒ… ê¸°ëŠ¥ êµ¬í˜„ ë˜ëŠ” ì±„íŒ… í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = '/myquote/chat';
    }

    // ì „í™” ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜  
    function makeCall(dealerNo) {
        // ë”œëŸ¬ë³„ ì „í™”ë²ˆí˜¸ ì„¤ì • (ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)
        const phoneNumbers = {
            'dealer1': '070-5854-8997',
            'dealer2': '070-1234-5678'
        };
        
        const phoneNumber = phoneNumbers[dealerNo] || '070-5854-8997';
        document.getElementById('phoneNumber').textContent = 'í†µí™” ' + phoneNumber;
        document.getElementById('phoneModal').style.display = 'flex';
        
        // ë°°ê²½ ìŠ¤í¬ë¡¤ ë°©ì§€
        document.body.style.overflow = 'hidden';
    }

    // ì‹¤ì œ ì „í™” ê±¸ê¸°
    function actualCall() {
        const phoneNumber = document.getElementById('phoneNumber').textContent.replace('í†µí™” ', '');
        window.location.href = 'tel:' + phoneNumber;
        closePhoneModal();
    }

    // ì „í™” ëª¨ë‹¬ ë‹«ê¸°
    function closePhoneModal() {
        document.getElementById('phoneModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ì‹œ ë‹«ê¸°
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('phoneModal');
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closePhoneModal();
            }
        });
    });
</script>

</body>
</html>
