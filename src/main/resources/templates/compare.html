<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>i-One Car | 상세 견적</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
    <link rel="stylesheet" th:href="@{/css/compare.css}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />
</head>
<body>
<div class="container">
    <div class="main-header">
        <span class="header-title">i-One Car ㅣ 견적 상세</span>
        <button class="close-btn">
            <img th:src="@{/css/images/X.png}" alt="닫기" class="close-icon" />
        </button>
    </div>
    <div class="detail-card">
        <!-- 차량정보/이미지 -->
        <div class="car-info-row">
            <div class="car-info-text">
                <div class="car-name" th:text="${carClass}"></div>
                <div class="car-desc">
                    <span th:text="${carSubClass}"></span><br/>
                    <span th:if="${purchase != null and purchase.purchaseMethod == 'C'}">일시불</span>
                    <span th:if="${purchase == null or purchase.purchaseMethod != 'C'}">
                        <span th:text="${purchaseMethod}"></span>
                        <span th:text="${purchasePeriod} + '개월'"></span>
                    </span>
                </div>
            </div>
            <div class="car-img-block">
                <img th:src="@{${carClass == 'A-Class' ? '/css/images/a-class.png' : '/css/images/bmwx1.png'}}" alt="차 이미지" class="car-img" />
            </div>
        </div>

        <!-- 가격정보: 하나의 회색 박스 -->
        <div class="price-area-box">
            <!-- 차량 기본가 -->
            <div class="price-detail">
                <span class="label">차량 기본가</span>
                <span class="price-value" th:text="${#numbers.formatInteger(carPrice, 0, 'COMMA')} + '원'"></span>
            </div>
            <!-- 추가 옵션가 -->
            <div class="price-detail">
                <span class="label">추가 옵션가</span>
                <span class="price-value" th:text="${#numbers.formatInteger(optPrice, 0, 'COMMA')} + '원'"></span>
            </div>
            <!-- 총 예상금액 -->
            <div class="price-detail total">
                <span class="label">총 예상금액</span>
                <span class="price-value" th:text="${#numbers.formatInteger(carPrice + optPrice, 0, 'COMMA')} + '원'"></span>
            </div>
        </div>

        <!-- 딜러 정보를 동적으로 표시 -->
        <div th:each="compare : ${compares}" class="dealer-label-with-card">
            <div class="dealer-label" 
                 th:text="${compare.progress == '1' ? '딜러와 상담요청 전입니다.' : (compare.progress == '2' ? '딜러와 상담이 진행중입니다.' : (compare.progress == '3' ? '딜러와 상담이 완료되었습니다.' : '딜러와 상담요청 전입니다.'))}"
                 th:style="${compare.progress == '2' ? 'color: red;' : (compare.progress == '3' ? 'color: green; font-weight: bold;' : '')}"></div>
            <div class="dealer-card">
                <img th:src="@{${compare.dealerName == '벤츠박사' ? '/css/images/dealer1.png' : '/css/images/dealer2.png'}}" alt="딜러 프로필" class="dealer-photo" />
                <div class="dealer-profile-info">
                    <span class="dealer-name" th:onclick="'goToProfile(\'' + ${compare.dealerNo} + '\')'" style="cursor: pointer;" th:text="${compare.dealerName}">딜러명</span>
                    <span class="dealer-rating">
                        <img th:src="@{/css/images/star.png}" alt="별" class="star-icon" />
                        <span th:text="${compare.rating}">5.0</span>
                        <span class="review-count" th:text="'(' + ${compare.reviewCnt} + ')'"></span>
                    </span>
                    <span class="quotation-count" th:text="${compare.quotationCnt} + '건'"></span>
                </div>
                <div class="dealer-body">
                    <div class="info-col">
                        <span class="label">할인금액</span>
                        <span class="value" th:text="${#numbers.formatInteger(compare.discount, 0, 'COMMA')} + '원'"></span>
                    </div>
                    <!-- 구매방법에 따른 조건부 표시 -->
                    <div th:if="${purchase != null and purchase.purchaseMethod == 'C'}" class="info-col">
                        <span class="label">일시납</span>
                        <span class="value" th:text="${#numbers.formatInteger((carPrice + optPrice - compare.discount) + ((carPrice * 0.07) + (carPrice * 0.12 * 0.05)), 0, 'COMMA')} + '원'"></span>
                    </div>
                    <div th:if="${purchase == null or purchase.purchaseMethod != 'C'}" class="info-col">
                        <span class="label">월납입료</span>
                        <span class="value" 
                              th:if="${purchase != null and compare.rate != null and purchase.purchaseAdvance != null and purchase.purchasePeriod != null}" 
                              th:text="${#numbers.formatInteger(T(java.lang.Math).round((carPrice + optPrice - compare.discount - purchase.purchaseAdvance ) * (1 + compare.rate/100) / purchase.purchasePeriod), 0, 'COMMA')} + '원'"></span>
                        <span class="value" 
                              th:unless="${purchase != null and compare.rate != null and purchase.purchaseAdvance != null and purchase.purchasePeriod != null}" 
                              th:text="${#numbers.formatInteger(compare.monthlyPayment != null ? compare.monthlyPayment : 0, 0, 'COMMA')} + '원'"></span>
                    </div>
                    <!-- 이용금리는 일시불('C')이 아닐 때만 표시 -->
                    <div th:if="${purchase == null or purchase.purchaseMethod != 'C'}" class="info-col">
                        <span class="label">이용금리</span>
                        <span class="value" th:text="${compare.rate} + '%'"></span>
                    </div>
                </div>
                <!-- 기존 단일 버튼 (progress가 2가 아닌 경우) -->
                <a th:if="${compare.progress != '2'}" th:href="@{/myquote/detail(carSrn=${carSrn}, dealerNo=${compare.dealerNo})}" class="dealer-detail-btn">상세견적</a>

                <!-- progress가 2인 경우 3개 버튼 -->
                <div th:if="${compare.progress == '2'}" class="triple-button-container">
                    <a th:href="@{/myquote/detail(carSrn=${carSrn}, dealerNo=${compare.dealerNo})}" class="triple-btn detail-btn">상세견적</a>
                    <button class="triple-btn chat-btn" th:data-dealer-no="${compare.dealerNo}" onclick="startChat(this.getAttribute('data-dealer-no'))">채팅하기</button>
                    <button class="triple-btn phone-btn" th:data-dealer-no="${compare.dealerNo}" onclick="makeCall(this.getAttribute('data-dealer-no'))">
                        <img th:src="@{/css/images/phone-icon.png}" alt="전화" class="phone-icon" />
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 전화 모달 -->
<div id="phoneModal" class="phone-modal-overlay" style="display: none;">
    <div class="phone-modal">
        <div class="phone-modal-content">
            <div class="phone-icon-large">📞</div>
            <div class="phone-number" id="phoneNumber">통화 070-5854-8997</div>
            <div class="phone-buttons">
                <button class="phone-call-btn" onclick="actualCall()">
                    <span class="phone-btn-icon">📞</span>
                    통화
                </button>
                <button class="phone-cancel-btn" onclick="closePhoneModal()">취소</button>
            </div>
        </div>
    </div>
</div>

<script>
    // 딜러 프로필로 이동하는 함수
    function goToProfile(dealerNo) {
        window.location.href = '/profile?dealerNo=' + dealerNo;
    }

    // 채팅 시작 함수
    function startChat(dealerNo) {
        console.log('startChat 함수 호출됨, dealerNo:', dealerNo);
        // 채팅 기능 구현 또는 채팅 페이지로 이동
        window.location.href = '/myquote/chat';
    }

    // 전화 모달 표시 함수  
    function makeCall(dealerNo) {
        // 딜러별 전화번호 설정 (실제로는 서버에서 가져와야 함)
        const phoneNumbers = {
            'dealer1': '070-5854-8997',
            'dealer2': '070-1234-5678'
        };
        
        const phoneNumber = phoneNumbers[dealerNo] || '070-5854-8997';
        document.getElementById('phoneNumber').textContent = '통화 ' + phoneNumber;
        document.getElementById('phoneModal').style.display = 'flex';
        
        // 배경 스크롤 방지
        document.body.style.overflow = 'hidden';
    }

    // 실제 전화 걸기
    function actualCall() {
        const phoneNumber = document.getElementById('phoneNumber').textContent.replace('통화 ', '');
        window.location.href = 'tel:' + phoneNumber;
        closePhoneModal();
    }

    // 전화 모달 닫기
    function closePhoneModal() {
        document.getElementById('phoneModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // 모달 배경 클릭시 닫기
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('phoneModal');
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closePhoneModal();
            }
        });
    });
</script>

</body>
</html>
