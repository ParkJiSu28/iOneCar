<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>i-One Car | 내 견적함</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
    <link rel="stylesheet" th:href="@{/css/myquote.css}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />
</head>
<body>
<div class="container">
    <div class="main-header">
        <span class="header-title">i-One Car ㅣ 내 견적함</span>
        <button class="close-btn">
            <img th:src="@{/css/images/X.png}" alt="닫기" class="close-icon" />
        </button>
    </div>
    
    <!-- 여러 차량을 반복하여 표시 -->
    <div th:each="myQuote : ${myQuotes}" class="estimate-card">
        <div class="card-label-row">
            <span class="status-label" 
                  th:text="${myQuote.progress == '1' ? '상담전' : (myQuote.progress == '2' ? '상담중' : (myQuote.progress == '3' ? '최종견적' : '상담전'))}"
                  th:style="${myQuote.progress == '2' ? 'color: red; cursor: pointer;' : (myQuote.progress == '3' ? 'color: green; font-weight: bold;' : '')}"
                  th:data-progress="${myQuote.progress}"
                  th:data-car-srn="${myQuote.carSrn}"
                  th:data-edps-csn="${edpsCsn}"></span>
            <div class="compare-area">
                <span class="compare-label">비교견적</span>
                <span class="compare-badge">2</span>
                <!-- 비교견적 아이콘 클릭 시 POST 방식으로 전송 -->
                <div class="compare-link" th:onclick="'sendToCompare(' + ${myQuote.carSrn} + ', ' + ${edpsCsn} + ')'" style="cursor: pointer;">
                    <img th:src="@{/css/images/right.png}" alt="비교견적 아이콘" class="compare-icon" />
                </div>
            </div>
        </div>
        <div class="label-separator"></div>
        <div class="car-info-row">
            <div class="car-info-text">
                <!-- DB에서 가져온 자동차 클래스명 -->
                <div class="car-name" th:text="${myQuote.carClass}">차량종류</div>
                <div class="car-desc">
                    <span th:text="${myQuote.carSubClass}">세부차종</span><br/>
                    <span th:text="${myQuote.purchaseMethod == 'I' ? '할부' : (myQuote.purchaseMethod == 'C' ? '현금' : '기타')}">구매방법</span>
                    <span th:text="${myQuote.purchasePeriod} + '개월'">구매기간</span>
                </div>
            </div>
            <div class="car-img-block">
                <!-- 실제 DB에서 이미지 경로를 갖고 있다면 carImgUrl 속성을 추가해 처리 가능 -->
                <img th:src="@{/css/images/a-class.png}" alt="차 이미지" class="car-img" />
            </div>
        </div>
        <div class="expire-box">
            <div th:if="${myQuote.progress == '3'}">
                <span class="expire-time" style="color: green; font-weight: bold;">최종견적 신청이 들어왔어요!</span>
            </div>
            <div th:if="${myQuote.progress == '2'}">
                <span class="expire-time" style="color: red;">상담이 진행 중입니다</span>
            </div>
            <div th:if="${myQuote.progress != '2' and myQuote.progress != '3'}">
                <span class="expire-time">31:35:27</span>
                <span class="expire-label">견적만료까지 남은시간 입니다</span>
            </div>
        </div>
    </div>
    
    <!-- 차량이 없는 경우 표시할 메시지 -->
    <div th:if="${#lists.isEmpty(myQuotes)}" class="no-quotes-message">
        <p>등록된 견적이 없습니다.</p>
    </div>
</div>

<script th:inline="javascript">
    // 페이지 로드 시 이벤트 리스너 등록
    document.addEventListener('DOMContentLoaded', function() {
        // 모든 status-label에 클릭 이벤트 추가
        const statusLabels = document.querySelectorAll('.status-label');
        statusLabels.forEach(label => {
            label.addEventListener('click', function() {
                const progress = this.dataset.progress;
                const carSrn = this.dataset.carSrn;
                const edpsCsn = this.dataset.edpsCsn;
                
                // progress가 '2'(상담중)인 경우에만 이스터에그 실행
                if (progress === '2') {
                    updateProgressEasterEgg(carSrn, edpsCsn);
                }
            });
        });
    });

    function sendToCompare(carSrn, edpsCsn) {
        // POST 방식으로 carSrn과 edpsCsn을 전송
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/myquote/compare';
        
        const carSrnInput = document.createElement('input');
        carSrnInput.type = 'hidden';
        carSrnInput.name = 'carSrn';
        carSrnInput.value = carSrn;
        
        const edpsCsnInput = document.createElement('input');
        edpsCsnInput.type = 'hidden';
        edpsCsnInput.name = 'edpsCsn';
        edpsCsnInput.value = edpsCsn;
        
        form.appendChild(carSrnInput);
        form.appendChild(edpsCsnInput);
        document.body.appendChild(form);
        form.submit();
    }
    
    // 이스터에그: 상담중 상태 클릭 시 progress를 3으로 업데이트
    function updateProgressEasterEgg(carSrn, edpsCsn) {
        // AJAX 요청으로 progress 업데이트
        fetch('/myquote/updateProgress', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `carSrn=${carSrn}&edpsCsn=${edpsCsn}`
        })
        .then(response => response.text())
        .then(data => {
            if (data === 'SUCCESS') {
                // 성공 시 페이지 새로고침하여 업데이트된 상태 반영
                window.location.reload();
            } else {
                console.error('Failed to update progress:', data);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
</script>
</body>
</html>
