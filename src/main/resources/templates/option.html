<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>옵션 선택</title>
  <link rel="stylesheet" th:href="@{/css/option.css}">
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const options = document.querySelectorAll('.option-card');
      const nextButton = document.querySelector('.next-btn');

      options.forEach(option => {
        option.addEventListener('click', function () {
          // 모든 옵션에서 selected 클래스 제거 (단일 선택)
          options.forEach(opt => opt.classList.remove('selected'));
          
          // 클릭된 옵션에만 selected 클래스 추가
          this.classList.add('selected');
          
          updateNextButton();
        });
      });

      function updateNextButton() {
        const anySelected = document.querySelectorAll('.option-card.selected').length > 0;
        if (anySelected) {
          nextButton.classList.add('active');
          nextButton.disabled = false;
        } else {
          nextButton.classList.remove('active');
          nextButton.disabled = true;
        }
      }

      // 가격 텍스트에서 숫자만 추출해 long 값으로 변환
      function parsePriceToLong(priceText) {
        // 예: '+ 1,650,000원' -> '1650000' -> 1650000
        const digits = (priceText || '').toString().replace(/[^0-9]/g, '');
        return digits ? parseInt(digits, 10) : 0;
      }

      // 이전 버튼: 직전 페이지로 이동
      prevButton.addEventListener('click', function () {
        window.history.back();
      });

      // 다음 버튼: 선택된 옵션들을 POST로 전송
      nextButton.addEventListener('click', function (e) {
        if (nextButton.disabled) return;
        e.preventDefault();

        const selected = document.querySelectorAll('.option-card.selected');
        if (!selected.length || !carSrn) return;

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/quote/option';

        // carSrn 추가
        const carSrnInput = document.createElement('input');
        carSrnInput.type = 'hidden';
        carSrnInput.name = 'carSrn';
        carSrnInput.value = carSrn;
        form.appendChild(carSrnInput);

        // 선택된 옵션 추가 (단일 선택이므로 하나만)
        selected.forEach(card => {
          const labelText = card.querySelector('.label')?.textContent?.trim() || '';
          const priceText = card.querySelector('.price')?.textContent?.trim() || '';
          const priceLong = parsePriceToLong(priceText);

          const labelInput = document.createElement('input');
          labelInput.type = 'hidden';
          labelInput.name = 'optionLabel';
          labelInput.value = labelText;

          const priceInput = document.createElement('input');
          priceInput.type = 'hidden';
          priceInput.name = 'optionPrice';
          priceInput.value = String(priceLong);

          form.appendChild(labelInput);
          form.appendChild(priceInput);
        });

        document.body.appendChild(form);
        form.submit();
      });

      // 초기 상태 설정
      updateNextButton();
    });
  </script>
</head>
<body>
  <header>
    <span>i-One Car</span>
    <span style="margin-left: 8px; font-size: 16px; font-weight: normal;">견적신청</span>
    <span style="margin-left: auto; cursor: pointer;">✕</span>
  </header>

  <div class="progress-bar">
    <div class="progress"></div>
  </div>

  <div class="container">
    <div class="title">옵션 선택</div>
    <div class="model-summary">
      <div class="text">
        <span class="name">A-Class</span>
        <span class="desc">2025년형 해치백 가솔린 2.0<br>A220</span>
      </div>
      <div class="image">
        <img src="/css/images/a-class.png" alt="A-Class">
      </div>
    </div>

    <div class="option-list">
      <div class="option-card">
        <div class="option-left">
          <span class="check">✔</span>
          <span class="label">버튼시동 Pack</span>
        </div>
        <div class="price">+ 520,000원</div>
        <div class="tooltip">?</div>
      </div>

      <div class="option-card">
        <div class="option-left">
          <span class="check">✔</span>
          <span class="label">8인치 네비게이션</span>
        </div>
        <div class="price">+ 1,650,000원</div>
        <div class="tooltip">?</div>
      </div>
    </div>
  </div>

  <div class="bottom-buttons">
    <button class="btn prev-btn">이전</button>
    <form th:action="@{/quote/buy}" method="get" style="flex: 1.5;">
      <button type="submit" class="btn next-btn" disabled>다음</button>
    </form>
  </div>
</body>
</html>
