<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>i-One Car | 내 견적함</title>
    <link rel="stylesheet" th:href="@{/css/detail.css}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- 상단 헤더 -->
        <header class="main-header">
            <h1 class="header-title">i-One Car | 내 견적함</h1>
            <button class="close-btn" onclick="history.back()">
                <img src="/css/images/X.png" alt="닫기" class="close-icon">
            </button>
        </header>

        <!-- 메인 컨텐츠 -->
        <main class="main-content">
            <!-- 상세견적 섹션 -->
            <div class="detail-section">
                <div class="section-header" onclick="toggleSection('detail')">
                    <h2 class="section-title">상세견적</h2>
                    <div class="toggle-icon" id="detail-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                </div>
                
                <div class="section-content" id="detail-content">
                    <!-- 차량 정보 -->
                    <div class="car-info">
                        <div class="car-details">
                            <h3 class="car-name" th:text="${car.carClass}"></h3>
                            <p class="car-spec" th:text="${car.carSubClass}"></p>
                        </div>
                        <div class="car-image">
                            <img src="/css/images/a-class.png" alt="A-Class" class="car-img">
                        </div>
                    </div>

                    <!-- 가격 정보 -->
                    <div class="price-info">
                        <div class="price-row">
                            <span class="price-label">차량 기본가</span>
                            <span class="price-value" th:text="${#numbers.formatInteger(car.carPrice, 0, 'COMMA')} + '원'">48,100,000원</span>
                        </div>
                        <div class="price-row">
                            <span class="price-label">추가 옵션가</span>
                            <span class="price-value" th:text="'+' + ${#numbers.formatInteger(optPrice, 0, 'COMMA')} + '원'">+520,000원</span>
                        </div>
                        <!-- 옵션 상세 정보 -->
                        <div th:each="option : ${options}" class="price-row option-detail">
                            <span class="option-text" th:text="${option.optName}">버튼시동팩</span>
                            <span class="option-price" th:text="${#numbers.formatInteger(option.optPrice, 0, 'COMMA')} + '원'"></span>
                        </div>
                        <div class="price-row discount">
                            <span class="price-label">할인가</span>
                            <span class="price-value discount" th:text="'-' + ${#numbers.formatInteger(discount, 0, 'COMMA')} + '원'">-5,000,000원</span>
                        </div>
                        <div class="price-row total">
                            <span class="price-label">총 예상금액</span>
                            <span class="price-value total" th:text="${#numbers.formatInteger(car.carPrice + optPrice - discount, 0, 'COMMA')} + '원'">43,620,000원</span>
                        </div>
                        <div class="price-note">
                            차량가는 개별 소비세 3.5%가 적용된 가격입니다.
                        </div>
                    </div>
                </div>
            </div>

            <!-- 등록비용 섹션 -->
            <div class="registration-section">
                <div class="section-header" onclick="toggleSection('registration')">
                    <h2 class="section-title">등록비용</h2>
                    <div class="toggle-icon" id="registration-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                </div>
                
                <div class="section-content" id="registration-content">
                    <div class="registration-total">
                        <span class="total-label">합계</span>
                        <span class="total-amount" th:text="${#numbers.formatInteger((car.carPrice * 0.07) + (car.carPrice * 0.12 * 0.05), 0, 'COMMA')} + '원'">2,834,246원</span>
                    </div>
                    <div class="registration-details">
                        <div class="detail-row">
                            <span class="detail-label">취득세</span>
                            <span class="detail-value" th:text="${#numbers.formatInteger(car.carPrice * 0.07, 0, 'COMMA')} + '원'">2,648,545원</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">면세조건</span>
                            <span class="detail-value">일반인(해당없음)</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">공채할인(예상)</span>
                            <span class="detail-value" th:text="${#numbers.formatInteger(car.carPrice * 0.12 * 0.05, 0, 'COMMA')} + '원'">185,701원</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">탁송료</span>
                            <span class="detail-value">0원</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">기타 부대비용</span>
                            <span class="detail-value">0원</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 구매정보 섹션 -->
            <div class="purchase-section">
                <div class="section-header" onclick="toggleSection('purchase')">
                    <h2 class="section-title">구매정보</h2>
                    <div class="toggle-icon" id="purchase-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                </div>
                
                <div class="section-content" id="purchase-content">
                    <div class="purchase-method">
                        <span class="method-label">구매방법</span>
                        <span class="method-value" th:text="${purchase != null ? (purchase.purchaseMethod == 'I' ? '할부' : (purchase.purchaseMethod == 'C' ? '일시불' : '할부')) : '할부'}">할부</span>
                    </div>
                    <div class="purchase-details">
                        <!-- 일시불일 경우 -->
                        <div th:if="${purchase != null and purchase.purchaseMethod == 'C'}">
                            <div class="detail-row">
                                <span class="detail-label">출고전 납입금액</span>
                                <span class="detail-value" th:text="${#numbers.formatInteger((car.carPrice + optPrice - discount) + ((car.carPrice * 0.07) + (car.carPrice * 0.12 * 0.05)), 0, 'COMMA')} + '원'">출고전 납입금액</span>
                            </div>
                        </div>
                        
                        <!-- 할부일 경우 -->
                        <div th:if="${purchase == null or purchase.purchaseMethod != 'C'}">
                            <div class="detail-row">
                                <span class="detail-label">금융사</span>
                                <span class="detail-value">IBK 카드</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">할부신청금</span>
                                <span class="detail-value" th:text="${purchase != null ? #numbers.formatInteger( (car.carPrice + optPrice - discount) -purchase.purchaseAdvance, 0, 'COMMA') + '원' : '33,620,000원'}"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">할부기간</span>
                                <span class="detail-value" th:text="${purchase != null ? purchase.purchasePeriod + '개월' : '48개월'}"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">선납금</span>
                                <span class="detail-value" th:text="${purchase != null ? #numbers.formatInteger(purchase.purchaseAdvance, 0, 'COMMA') + '원' : '10,000,000원'}"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">금리(연)</span>
                                <span class="detail-value" th:text="${rate != null ? rate + '%' : '7%'}"></span>
                            </div>
                            <div class="detail-row highlight">
                                <span class="detail-label">월 납입금</span>
                                <span class="detail-value highlight" th:text="${purchase != null && rate != null ? #numbers.formatInteger(T(java.lang.Math).round((car.carPrice + optPrice - discount - purchase.purchaseAdvance ) * (1 + rate/100) / purchase.purchasePeriod), 0, 'COMMA') + '원' : '805,073원'}"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">출고전 납입금액</span>
                                <span class="detail-value" th:text="${purchase != null ? #numbers.formatInteger((car.carPrice + optPrice - discount) + (car.carPrice * 0.07) + (car.carPrice * 0.12 * 0.05) - purchase.purchaseAdvance, 0, 'COMMA') + '원' : '10,000,000원'}"></span>
                            </div>
                        </div>
                        <div class="detail-note" style="font-size: 12px; color: #666; margin-top: 5px;">
                            차량등록금액이 포함된 금액입니다.
                        </div>
                    </div>
                </div>
            </div>

            <!-- 차량 상세 정보 -->
            <div class="car-details-section">
                <div class="detail-row">
                    <span class="detail-label">지역</span>
                    <span class="detail-value" th:text="${purchase != null ? purchase.purchaseLocation : '서울'}"></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">재고유무</span>
                    <span class="detail-value">1개월 이내 출고</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">외장색상</span>
                    <span class="detail-value" th:text="${car.carColor != null ? car.carColor : '폴라 화이트'}">폴라 화이트</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">내장색상</span>
                    <span class="detail-value" th:text="${car.carInteriorColor != null ? car.carInteriorColor : '아티코 블랙 / 블랙'}">아티코 블랙 / 블랙</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">포함서비스</span>
                    <span class="detail-value">틴팅, 블랙박스</span>
                </div>
            </div>

            <!-- 요청사항 섹션 -->
            <div class="requests-section">
                <div class="section-header" onclick="toggleSection('requests')">
                    <h2 class="section-title">요청사항</h2>
                    <div class="toggle-icon" id="requests-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                </div>
                
                <div class="section-content" id="requests-content">
                    <div class="request-list">
                        <div class="request-item">
                            <span class="request-text">비대면 거래도 괜찮아요</span>
                            <input type="checkbox" class="request-checkbox" checked>
                        </div>
                        <div class="request-item">
                            <span class="request-text">출고 시 용품 서비스가 궁금해요</span>
                            <input type="checkbox" class="request-checkbox" checked>
                        </div>
                        <div class="request-item">
                            <span class="request-text">조건이 맞으면 계약 의사가 있어요</span>
                            <input type="checkbox" class="request-checkbox" checked>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 딜러 정보 -->
            <div class="dealer-section" th:if="${compares != null and !compares.isEmpty()}">
                <div th:each="compare : ${compares}" class="dealer-info">
                    <div class="dealer-profile">
                        <div class="dealer-avatar">
                            <img th:src="@{/css/images/dealer1.png}" alt="딜러" class="avatar-img">
                        </div>
                        <div class="dealer-details">
                            <div class="dealer-name">
                                <span th:onclick="'goToProfile(\'' + ${compare.dealerNo} + '\')'" 
                                      style="cursor: pointer;" 
                                      th:text="${compare.dealerName}">벤츠박사</span>
                                <div class="verified-badge">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="#235FD2">
                                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="dealer-stats">
                                <span class="rating" th:text="${compare.rating} + '(' + ${compare.reviewCnt} + ')'">5.0(67)</span>
                                <span class="quotes" th:text="'매칭견적 ' + ${compare.quotationCnt} + '건'">매칭견적 1,416건</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

                 <!-- 하단 버튼 -->
         <div class="bottom-button">
             <button class="btn btn-primary" 
                     th:onclick="${deal != null and deal.progress == '3'} ? 'handlePayment()' : 'showModal()'"
                     th:text="${deal != null and deal.progress == '3'} ? '결제 하러가기' : '상담 신청하기'">상담 신청하기</button>
         </div>
     </div>

     <!-- 모달 오버레이 -->
     <div class="modal-overlay" id="modalOverlay">
         <!-- 모달 -->
         <div class="modal" id="modal">
             <div class="modal-header">
                 <button class="modal-close-btn" onclick="hideModal()">
                     <img src="/css/images/X.png" alt="닫기" class="close-icon">
                 </button>
             </div>
             
             <div class="modal-content">
                 <h2 class="modal-title">해당 견적으로 신청하겠습니까?</h2>
                 
                 <div class="modal-description">
                     <p>이제 선택하신 견적을 바탕으로 매니저가 1:1로 배정돼요. 계약까지 함께할 매니저인 만큼, 아래 내용 확인해 주세요 😊</p>
                 </div>
                 
                 <div class="modal-bullet-points">
                     <div class="bullet-point">
                         <span class="bullet">•</span>
                         <span class="point-text">선택한 차량 정보, 옵션, 색상, 금융 방식(할부/리스/렌트), 그리고 부가비용(탁송비, 등록비 등)을 다시 한번 체크해 주세요.</span>
                     </div>
                     <div class="bullet-point">
                         <span class="bullet">•</span>
                         <span class="point-text">매니저 배정 이후에는 견적 변경이 어려울 수 있어요.</span>
                     </div>
                     <div class="bullet-point">
                         <span class="bullet">•</span>
                         <span class="point-text">재고나 조건은 실제 딜러 상황에 따라 달라질 수 있어요. 매니저가 다시 한번 확인해 드릴 거예요!</span>
                     </div>
                     <div class="bullet-point">
                         <span class="bullet">•</span>
                         <span class="point-text">카랩 매니저 회원은 모두 제휴계약서를 작성한 검증된 분들이며, 법적으로 보호받을 수 있는 공식 매니저입니다. 믿고 진행해 주세요</span>
                     </div>
                 </div>
                 
                 <div class="modal-checkbox">
                     <label class="checkbox-item">
                         <input type="checkbox" id="confirmCheckbox" class="modal-checkbox-input">
                         <span class="checkmark"></span>
                         <span class="checkbox-text">위 내용을 모두 확인했습니다.</span>
                     </label>
                 </div>
                 
                 <div class="modal-buttons">
                     <button class="btn btn-secondary" onclick="hideModal()">취소</button>
                     <button class="btn btn-primary" onclick="confirmSelection()">확인</button>
                 </div>
             </div>
         </div>
     </div>

     <!-- 할부 약관 팝업 (할부인 경우에만 렌더링) -->
     <div th:if="${purchase != null and purchase.purchaseMethod == 'I'}" class="installment-popup-overlay" id="installmentPopupOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: flex-end;">
         <div class="installment-popup" style="background: white; width: 100%; max-width: 375px; border-radius: 20px 20px 0 0; max-height: 80vh; display: flex; flex-direction: column;">
             <div class="popup-header" style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                 <h3 style="margin: 0; font-size: 18px; font-weight: 600;">자동차 결제 진행 안내사항 (할부)</h3>
                 <button class="popup-close" onclick="closeInstallmentPopup()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">×</button>
             </div>
             <div class="popup-content" style="flex: 1; overflow-y: auto; padding: 20px;">
                 <div class="checkbox-wrapper" style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                     <input type="checkbox" id="agreeTerms" style="width: 18px; height: 18px;" />
                     <label for="agreeTerms" style="font-size: 14px; color: #333; cursor: pointer;">위 내용을 모두 확인했습니다.</label>
                 </div>
                 <div class="terms-content" style="font-size: 12px; line-height: 1.6; color: #666;">
                     <p style="margin-bottom: 8px;">· 자동차 카드할부는 철회가 불가능 합니다.</p>
                     <p style="margin-bottom: 8px;">· 자동차 카드할부 이용중 2개월 이상 연체하거나 임의적으로 차량 명의 이전시 진행하신 할부금액에 대해 일시청구 가능합니다.</p>
                     <p style="margin-bottom: 8px;">· 고객님의 신용도에 따라 대출은 제한될 수 있으며 금리 및 이용조건은 카드사의 사정에 따라 변경,중단될 수 있습니다.</p>
                     <p style="margin-bottom: 8px;">· 계약 체결 전 카드상품별 연회비, 이용조건 등에 관한 상세사항은 금융상품설명서, 약관 및 홈페이지 참조바랍니다.</p>
                     <p style="margin-bottom: 8px;">· 금융소비자는 금융소비자보호법 제19조 제1항에 따라 해당 금융상품 또는 서비스에 대하여 설명 받을 권리가 있습니다.</p>
                     <p style="margin-bottom: 8px;">· 연체이자율은 회원별, 이용상품별 약정금리+최대 연 3% 법정최고금리(연 20%)이내 단, 연체 발생 시점에 약정금리가 없는 경우 아래와 같이 적용합니다.</p>
                     <p style="margin-bottom: 8px;">일시불 거래 연체 시 : 거래 발생 시점의 최소기간(2개월) 유이자 할부금리</p>
                     <p style="margin-bottom: 8px;">무이자 할부 거래 연체 시: 거래 발생 시점의 동일한 할부 계약기간의 유이자 할부금리</p>
                     <p style="margin-bottom: 8px;">그외의 경우 : 약정금리는 상법상 상사법정이율과 상호금융가계자금대출금*중 높음 금리적용</p>
                     <p style="margin-bottom: 8px;">*한국은행에서 매월 발표하는 가장 최근의 비은행 금융기관 가중평균대출금리(신규대출 기준)</p>
                     <p style="margin-bottom: 8px;">신용카드 발급이 부적정한 경우(개인신용평점 낮음, 연체(단기 포함) 사유 발생 등), 카드발급이 제한될 수 있습니다.</p>
                     <p style="margin-bottom: 8px;">상환능력에 비해 신용카드 사용액이 과도할 경우, 귀하의 개인신용평점이 하락할 수 있습니다.</p>
                     <p style="margin-bottom: 8px;">개인신용평점 하락 시 금융거래와 관련된 불이익이 발생할 수 있습니다.</p>
                     <p style="margin-bottom: 8px;">일정기간 신용카드 이용대금을 연체할 경우, 결제일이 도래하지 않은 모든 신용카드 이용대금을 변제할 의무가 발생할 수 있습니다.</p>
                     <p style="margin-bottom: 8px;">카드 이용대금과 이에 수반되는 모든 수수료는 고객님께서 지정하신 결제일에 상환하여야 합니다.</p>
                 </div>
             </div>
             <div class="popup-buttons" style="padding: 20px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                 <button class="btn-cancel" onclick="closeInstallmentPopup()" style="flex: 1; padding: 12px; background: #f5f5f5; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">취소</button>
                 <button class="btn-confirm" id="confirmBtn" onclick="confirmInstallment()" disabled style="flex: 1; padding: 12px; background: #235FD2; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; opacity: 0.5;">확인</button>
             </div>
         </div>
     </div>

     <script th:inline="javascript">
         // 서버 데이터를 JavaScript 변수로 안전하게 전달
         var carSrn = /*[[${carSrn}]]*/ null;
         var dealerNo = /*[[${deal != null ? deal.dealerNo : null}]]*/ null;
         var edpsCsn = /*[[${edpsCsn}]]*/ null;
         var purchaseMethod = /*[[${purchase != null ? purchase.purchaseMethod : null}]]*/ null;
         
         console.log('=== 서버에서 전달된 데이터 ===');
         console.log('carSrn:', carSrn);
         console.log('dealerNo:', dealerNo);
         console.log('edpsCsn:', edpsCsn);
         console.log('purchaseMethod:', purchaseMethod);
         console.log('purchaseMethod type:', typeof purchaseMethod);

         function toggleSection(sectionId) {
             const content = document.getElementById(sectionId + '-content');
             const icon = document.getElementById(sectionId + '-icon');
             
             if (content.style.display === 'none') {
                 content.style.display = 'block';
                 icon.style.transform = 'rotate(0deg)';
             } else {
                 content.style.display = 'none';
                 icon.style.transform = 'rotate(180deg)';
             }
         }

         function showModal() {
             const overlay = document.getElementById('modalOverlay');
             const modal = document.getElementById('modal');
             
             overlay.style.display = 'flex';
             overlay.style.opacity = '0';
             modal.style.transform = 'translateY(100%)';
             
             setTimeout(() => {
                 overlay.style.opacity = '1';
                 modal.style.transform = 'translateY(0)';
             }, 10);
         }

         function hideModal() {
             const overlay = document.getElementById('modalOverlay');
             const modal = document.getElementById('modal');
             
             overlay.style.opacity = '0';
             modal.style.transform = 'translateY(100%)';
             setTimeout(() => {
                 overlay.style.display = 'none';
             }, 300);
         }

        function confirmSelection() {
            const checkbox = document.getElementById('confirmCheckbox');
            if (!checkbox.checked) {
                alert('위 내용을 모두 확인해 주세요.');
                return;
            }
            
            // URL에서 파라미터 가져오기
            const urlParams = new URLSearchParams(window.location.search);
            const edpsCsn = urlParams.get('edpsCsn');
            const carSrn = urlParams.get('carSrn');
            const dealerNo = urlParams.get('dealerNo');
            
            // Deal progress 업데이트 API 호출
            if (carSrn && dealerNo) {
                const formData = new FormData();
                formData.append('carSrn', carSrn);
                formData.append('dealerNo', dealerNo);
                
                fetch('/myquote/deal/confirm', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        console.log('Deal progress updated successfully');
                    } else {
                        console.error('Failed to update deal progress');
                    }
                })
                .catch(error => {
                    console.error('Error updating deal progress:', error);
                });
            }
            
            // submit_deal 페이지로 이동
            let redirectUrl = '/quote/submit-deal';
            if (edpsCsn) {
                redirectUrl += '?edpsCsn=' + edpsCsn;
                if (carSrn) {
                    redirectUrl += '&carSrn=' + carSrn;
                }
            }
            
            window.location.href = redirectUrl;
        }

                 // 페이지 로드 시 모든 섹션을 펼쳐진 상태로 시작
        document.addEventListener('DOMContentLoaded', function() {
            const sections = ['detail', 'registration', 'purchase', 'requests'];
            sections.forEach(sectionId => {
                const icon = document.getElementById(sectionId + '-icon');
                if (icon) {
                    icon.style.transform = 'rotate(0deg)';
                }
            });
        });

        // 딜러 프로필로 이동하는 함수
        function goToProfile(dealerNo) {
            window.location.href = '/profile?dealerNo=' + dealerNo;
        }

        // 결제 처리 함수
        function handlePayment() {
            console.log('=== 결제 처리 함수 실행 ===');
            console.log('carSrn:', carSrn);
            console.log('dealerNo:', dealerNo);
            console.log('purchaseMethod:', purchaseMethod);
            console.log('purchaseMethod type:', typeof purchaseMethod);
            console.log('purchaseMethod === "C":', purchaseMethod === 'C');
            console.log('purchaseMethod === "I":', purchaseMethod === 'I');
            
            // 데이터 유효성 검사
            if (!carSrn || !dealerNo) {
                console.error('❌ 필수 데이터가 누락되었습니다:', { carSrn, dealerNo });
                alert('필수 정보가 누락되었습니다. 페이지를 새로고침해주세요.');
                return;
            }
            
            // 구매방법에 따른 처리
            if (purchaseMethod === 'C') {
                console.log('✅ 일시불 처리 확인됨 - progress 5로 업데이트 후 myquote로 이동');
                updateProgressToFive(carSrn, dealerNo);
            } else if (purchaseMethod === 'I') {
                console.log('✅ 할부 처리 확인됨 - 약관 팝업 표시');
                showInstallmentPopup();
            } else {
                console.log('❌ 알 수 없는 구매방법:', purchaseMethod);
                console.log('기본 할부 처리로 약관 팝업 표시');
                showInstallmentPopup();
            }
        }

        // 할부 약관 팝업 표시
        function showInstallmentPopup() {
            const popup = document.getElementById('installmentPopupOverlay');
            if (popup) {
                popup.style.display = 'flex';
            } else {
                console.error('할부 약관 팝업을 찾을 수 없습니다. 일시불인 경우 팝업이 렌더링되지 않습니다.');
                // 팝업이 없으면 바로 결제 페이지로 이동
                window.location.href = '/payment?carSrn=' + carSrn;
            }
        }

        // 할부 약관 팝업 닫기
        function closeInstallmentPopup() {
            const popup = document.getElementById('installmentPopupOverlay');
            const agreeCheckbox = document.getElementById('agreeTerms');
            const confirmBtn = document.getElementById('confirmBtn');
            
            if (popup) popup.style.display = 'none';
            if (agreeCheckbox) agreeCheckbox.checked = false;
            if (confirmBtn) confirmBtn.disabled = true;
        }

        // 약관 동의 체크박스 이벤트
        document.addEventListener('DOMContentLoaded', function() {
            const agreeCheckbox = document.getElementById('agreeTerms');
            const confirmBtn = document.getElementById('confirmBtn');
            
            if (agreeCheckbox && confirmBtn) {
                agreeCheckbox.addEventListener('change', function() {
                    confirmBtn.disabled = !this.checked;
                    confirmBtn.style.opacity = this.checked ? '1' : '0.5';
                });
            }
        });

        // 일시불 전용 progress 업데이트 함수
        function updateProgressToFive(carSrnParam, dealerNoParam) {
            const formData = new FormData();
            formData.append('carSrn', carSrnParam);
            formData.append('dealerNo', dealerNoParam);
            formData.append('progress', '5');

            console.log('일시불 progress 업데이트 - carSrn:', carSrnParam, 'dealerNo:', dealerNoParam, 'progress: 5');
            console.log('EdpsCsn:', edpsCsn);

            fetch('/myquote/deal/updateProgress', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('Progress 업데이트 응답 상태:', response.status);
                if (response.ok) {
                    console.log('✅ Progress 5 업데이트 성공 - myquote로 이동');
                    const myquoteUrl = edpsCsn ? '/myquote?edpsCsn=' + edpsCsn : '/myquote';
                    console.log('이동할 URL:', myquoteUrl);
                    window.location.href = myquoteUrl;
                } else {
                    console.error('❌ Progress 업데이트 실패 - 그래도 myquote로 이동');
                    const myquoteUrl = edpsCsn ? '/myquote?edpsCsn=' + edpsCsn : '/myquote';
                    window.location.href = myquoteUrl;
                }
            })
            .catch(error => {
                console.error('❌ Progress 업데이트 에러:', error);
                console.log('에러 발생 - 그래도 myquote로 이동');
                const myquoteUrl = edpsCsn ? '/myquote?edpsCsn=' + edpsCsn : '/myquote';
                window.location.href = myquoteUrl;
            });
        }

        // 할부 약관 확인 버튼
        function confirmInstallment() {
            console.log('✅ 할부 약관 확인 - payment 페이지로 이동');
            console.log('carSrn:', carSrn);
            
            if (!carSrn) {
                console.error('❌ carSrn이 누락되었습니다.');
                alert('필수 정보가 누락되었습니다. 페이지를 새로고침해주세요.');
                return;
            }
            
            closeInstallmentPopup();
            // 할부인 경우 progress 업데이트 없이 바로 payment로 이동
            window.location.href = '/payment?carSrn=' + carSrn;
        }

        // Progress 업데이트 후 페이지 이동
        function updateProgressAndRedirect(carSrnParam, dealerNoParam, progressValue) {
            const formData = new FormData();
            formData.append('carSrn', carSrnParam);
            formData.append('dealerNo', dealerNoParam);
            formData.append('progress', progressValue);

            console.log('Updating progress to:', progressValue, 'for carSrn:', carSrnParam, 'dealerNo:', dealerNoParam);
            console.log('EdpsCsn:', edpsCsn);

            fetch('/myquote/deal/updateProgress', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('Update response status:', response.status);
                if (response.ok) {
                    // 일시불(progress 5)인 경우 myquote로, 할부(progress 4)인 경우 payment로 이동
                    if (progressValue === '5') {
                        console.log('일시불 완료 - myquote로 이동');
                        const myquoteUrl = edpsCsn ? '/myquote?edpsCsn=' + edpsCsn : '/myquote';
                        console.log('이동할 URL:', myquoteUrl);
                        window.location.href = myquoteUrl;
                    } else {
                        console.log('할부 진행 - payment로 이동');
                        window.location.href = '/payment?carSrn=' + carSrnParam;
                    }
                } else {
                    console.error('Failed to update progress');
                    // 에러가 발생해도 이동
                    if (progressValue === '5') {
                        const myquoteUrl = edpsCsn ? '/myquote?edpsCsn=' + edpsCsn : '/myquote';
                        window.location.href = myquoteUrl;
                    } else {
                        window.location.href = '/payment?carSrn=' + carSrnParam;
                    }
                }
            })
            .catch(error => {
                console.error('Error updating progress:', error);
                // 에러가 발생해도 이동
                if (progressValue === '5') {
                    const myquoteUrl = edpsCsn ? '/myquote?edpsCsn=' + edpsCsn : '/myquote';
                    window.location.href = myquoteUrl;
                } else {
                    window.location.href = '/payment?carSrn=' + carSrnParam;
                }
            });
        }
     </script>
</body>
</html> 